"use strict";var _interopRequireDefault=require("@babel/runtime-corejs2/helpers/interopRequireDefault"),_Object$defineProperty=require("@babel/runtime-corejs2/core-js/object/define-property");_Object$defineProperty(exports,"__esModule",{value:!0}),exports.default=rpk;var _promise=_interopRequireDefault(require("@babel/runtime-corejs2/core-js/promise")),_path=_interopRequireDefault(require("path")),_jszip=_interopRequireDefault(require("jszip")),_cliSharedUtils=require("@vivo-minigame/cli-shared-utils"),_bundle=require("./bundle"),_constanst=require("./constanst");/**
 * 打rpk包
 * @param {String} name rpk包的文件名
 * @param {Array(String)} buildReses rpk对应的资源路径
 * @param {String} pathFrom 打包rpk到何处
 * @param {String} pathTo 打包rpk到何处
 * @param {Object} signFile 签名文件信息
 */function rpk(a,b,c,d,e){// 保证打包路径存在，不存在就创建
return _cliSharedUtils.fs.ensureDir(d).then(()=>((0,_cliSharedUtils.info)(`${_constanst.LOG_TITLE}开始压缩:${a} from:${c}`),new _promise.default(f=>{const g=_path.default.join(d,`bundle.${Math.random()}.zip`),h=_cliSharedUtils.fs.createWriteStream(g),i=new _jszip.default,j=[];h.on("finish",()=>{// 生成签名文件
const b=_cliSharedUtils.fs.readFileSync(e.privatekey),c=_cliSharedUtils.fs.readFileSync(e.certificate);(0,_bundle.signZip)({zip:g,files:j},b,c,_path.default.join(d,`${a}`)),_cliSharedUtils.fs.removeSync(g),(0,_cliSharedUtils.info)(`${_constanst.LOG_TITLE}压缩完成:${a}`),f()}),b.forEach(a=>{const b=_path.default.join(c,a);j.push({name:a,file:b,hash:(0,_bundle.hashFile)(b)}),i.file(a,_cliSharedUtils.fs.createReadStream(b))}),i.generateNodeStream({compression:"DEFLATE",compressionOptions:{level:9}}).pipe(h)}))).catch(a=>{(0,_cliSharedUtils.error)(a)})}