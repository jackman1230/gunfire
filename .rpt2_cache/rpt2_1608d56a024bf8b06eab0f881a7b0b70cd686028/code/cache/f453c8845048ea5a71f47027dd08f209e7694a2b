{
  "code": "import { ViewManager } from \"../Manager/ViewManager\";\r\nimport PlayerBody from \"./Body/PlayerBody\";\r\nimport { EventManager } from \"../Manager/EventManager\";\r\nimport GameEvent from \"../Control/GameEvent\";\r\nimport { GameManager } from \"../Manager/GameManager\";\r\nimport { PlayerData } from \"../Data/PlayerData\";\r\nimport { SoundManager } from \"../Manager/SoundManager\";\r\nimport PlayerCtlView from \"./PlayerCtlView\";\r\nexport default class Player extends Laya.Script {\r\n    constructor() {\r\n        super();\r\n        this.direction = 1;\r\n        this.sRun = false;\r\n        this.sFire = false;\r\n        this.sBoom = false;\r\n        this.keyRight = false;\r\n        this.keyLeft = false;\r\n        this.keyJump = false;\r\n        this.stillRifle = false;\r\n        this.speed = 5;\r\n        this.jumpHigh = 200;\r\n        this.weaponType = 1;\r\n        this.faceType = 1;\r\n        this.stillFireNum = 1;\r\n    }\r\n    createView() {\r\n        Laya.Scene.load(\"PlayerBody.scene\", Laya.Handler.create(this, this.loadComplete));\r\n    }\r\n    ;\r\n    loadComplete(s) {\r\n        this.roleSprite = s;\r\n        this.rolePlayer = fairygui.UIPackage.createObject(\"Game\", \"Player\");\r\n        this.rolePlayer.setPivot(0.5, 0.5);\r\n        this.body = this.rolePlayer.getChildAt(0);\r\n        this.rolePlayer.m_fireType.selectedIndex = 0;\r\n        this.rolePlayer.m_firePos1.visible = this.rolePlayer.m_firePos2.visible = this.rolePlayer.m_firePos3.visible = false;\r\n        this.roleBody = this.roleSprite.getComponent(Laya.RigidBody);\r\n        this.roleCol = this.roleSprite.getComponent(Laya.BoxCollider);\r\n        this.roleSprite.addChild(this.rolePlayer.displayObject);\r\n        this.roleSprite.addComponent(PlayerBody);\r\n        this.bodyScript = this.roleSprite.getComponent(PlayerBody);\r\n        if (!this.playerCtlView)\r\n            this.playerCtlView = new PlayerCtlView();\r\n        fairygui.GRoot.inst.addChild(this.playerCtlView.view);\r\n        EventManager.instance.addNotice(GameEvent.PLAYER_COLLISION_GROUND, this, this.colliGround);\r\n        EventManager.instance.addNotice(GameEvent.ENEMY_BULLET_HIT_PLAYER, this, this.beHit);\r\n        EventManager.instance.addNotice(GameEvent.ENEMY_BOMB_HIT_PLAYER, this, this.beHit);\r\n        EventManager.instance.addNotice(GameEvent.CHANGE_PLAYER_WEAPON, this, this.changeWeaponType);\r\n        EventManager.instance.addNotice(GameEvent.PLAYER_DEATH, this, this.setDeath);\r\n        Laya.stage.on(Laya.Event.KEY_DOWN, this, this.keyDowmEvent);\r\n        Laya.stage.on(Laya.Event.KEY_UP, this, this.keyUpEvent);\r\n        this.playerCtlView.view.m_fire.on(Laya.Event.MOUSE_DOWN, this, this.setFire);\r\n        this.playerCtlView.view.m_fire.on(Laya.Event.MOUSE_UP, this, this.setFireEnd);\r\n        this.playerCtlView.view.m_bomb.on(Laya.Event.CLICK, this, this.onClickBomb);\r\n        this.playerCtlView.view.m_jump.on(Laya.Event.CLICK, this, this.onClickJump);\r\n        this.playerCtlView.view.m_ctl.m_mask.on(Laya.Event.MOUSE_DOWN, this, this.addMouseDown);\r\n        this.playerCtlView.view.m_ctl.m_mask.on(Laya.Event.MOUSE_UP, this, this.addCtlViewMouseUp);\r\n        Laya.stage.on(Laya.Event.MOUSE_UP, this, this.addStageMouseUp);\r\n        this.addCtlViewMouseUp();\r\n        this.resetPos();\r\n    }\r\n    resetPos() {\r\n        var d = GameManager.instance.curLvData;\r\n        this.roleSprite.x = d.rolePos[0];\r\n        this.roleSprite.y = d.rolePos[1];\r\n        this.weaponType = GameManager.instance.roleInfo.weaponType;\r\n        ViewManager.instance.warView.scene.addChild(this.roleSprite);\r\n    }\r\n    addCtlViewMouseUp() {\r\n        this.playerCtlView.view.m_ctl.m_dirBtn.y = this.playerCtlView.view.m_ctl.m_dirBtn.x = 0;\r\n        this.setStay();\r\n    }\r\n    addMouseDown(e) {\r\n        this.setDirection();\r\n        this.playerCtlView.view.m_ctl.m_mask.on(Laya.Event.MOUSE_MOVE, this, this.setDirection);\r\n    }\r\n    setDirection() {\r\n        var pos = this.playerCtlView.view.m_ctl.globalToLocal(Laya.stage.mouseX, Laya.stage.mouseY);\r\n        pos.x += 131;\r\n        pos.y += 131;\r\n        this.playerCtlView.view.m_ctl.m_dirBtn.x = pos.x;\r\n        this.playerCtlView.view.m_ctl.m_dirBtn.y = pos.y;\r\n        if (pos.x > 130)\r\n            this.playerCtlView.view.m_ctl.m_dirBtn.x = 130;\r\n        if (pos.x < -130)\r\n            this.playerCtlView.view.m_ctl.m_dirBtn.x = -130;\r\n        if (pos.y > 130)\r\n            this.playerCtlView.view.m_ctl.m_dirBtn.y = 130;\r\n        if (pos.y < -130)\r\n            this.playerCtlView.view.m_ctl.m_dirBtn.y = -130;\r\n        this.faceType = GameManager.instance.roleInfo.direction = ViewManager.instance.getPlayerDirection(pos);\r\n        if (this.faceType > 0) {\r\n            this.rolePlayer.skewY = 180;\r\n            this.keyRight = true;\r\n            this.keyLeft = false;\r\n            if (this.faceType == 1) {\r\n                this.direction = 1;\r\n                this.setRightRun();\r\n            }\r\n            else {\r\n                this.sRun = false;\r\n                Laya.timer.clear(this, this.stillRun);\r\n            }\r\n        }\r\n        else {\r\n            this.keyLeft = true;\r\n            this.keyRight = false;\r\n            this.rolePlayer.skewY = 0;\r\n            if (this.faceType == -1) {\r\n                this.direction = -1;\r\n                this.setLeftRun();\r\n            }\r\n            else {\r\n                this.sRun = false;\r\n                Laya.timer.clear(this, this.stillRun);\r\n            }\r\n        }\r\n        this.setPlayerDir();\r\n    }\r\n    addStageMouseUp() {\r\n        this.playerCtlView.view.m_ctl.m_mask.off(Laya.Event.MOUSE_MOVE, this, this.setDirection);\r\n    }\r\n    keyUpEvent(e) {\r\n        var keyCode = e[\"keyCode\"];\r\n        switch (keyCode) {\r\n            case 87:\r\n                this.setFireEnd();\r\n                break;\r\n            case 65:\r\n                this.keyLeft = false;\r\n                if (this.keyRight == false) {\r\n                    this.sRun = false;\r\n                    if (this.keyJump == false)\r\n                        this.stopMove();\r\n                }\r\n                break;\r\n            case 68:\r\n                this.keyRight = false;\r\n                if (this.keyLeft == false) {\r\n                    this.sRun = false;\r\n                    if (this.keyJump == false)\r\n                        this.stopMove();\r\n                }\r\n                break;\r\n        }\r\n    }\r\n    keyDowmEvent(e) {\r\n        var keyCode = e[\"keyCode\"];\r\n        switch (keyCode) {\r\n            case 87:\r\n                this.setFire();\r\n                console.log(\"上\");\r\n                break;\r\n            case 83:\r\n                console.log(\"下\");\r\n                break;\r\n            case 65:\r\n                this.keyLeft = true;\r\n                this.rolePlayer.skewY = 0;\r\n                if (this.sRun)\r\n                    return;\r\n                this.setRun();\r\n                this.stillRun();\r\n                break;\r\n            case 68:\r\n                this.keyRight = true;\r\n                this.rolePlayer.skewY = 180;\r\n                if (this.sRun)\r\n                    return;\r\n                this.setRun();\r\n                this.stillRun();\r\n                break;\r\n            case 32:\r\n                break;\r\n            case 81:\r\n                break;\r\n            case 69:\r\n                console.log(\"切枪\");\r\n                break;\r\n        }\r\n    }\r\n    onClickBomb() {\r\n        console.log(\"扔雷\");\r\n        if (this.sBoom)\r\n            return;\r\n        if (GameManager.instance.roleInfo.bombNum <= 0)\r\n            return;\r\n        this.setBoom();\r\n    }\r\n    onClickJump() {\r\n        console.log(\"跳\");\r\n        if (this.keyJump)\r\n            return;\r\n        this.setJump();\r\n    }\r\n    setLeftRun() {\r\n        if (this.sRun)\r\n            return;\r\n        this.setRun();\r\n        this.stillRun();\r\n    }\r\n    setRightRun() {\r\n        if (this.sRun)\r\n            return;\r\n        this.setRun();\r\n        this.stillRun();\r\n    }\r\n    setPlayerDir() {\r\n        if (!this.sFire) {\r\n            this.body.url = \"ui://Game/player_stay_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        }\r\n        else {\r\n            this.body.url = \"ui://Game/player_fire_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        }\r\n    }\r\n    colliGround() {\r\n        if (this.keyJump)\r\n            this.jumpEnd();\r\n    }\r\n    setJump() {\r\n        this.keyJump = true;\r\n        this.setBoomComplete();\r\n        this.bodyLeg.url = \"ui://Game/legJump\";\r\n        this.jummpTween = Laya.Tween.to(this.roleSprite, { y: this.roleSprite.y - this.jumpHigh }, 350, null, Laya.Handler.create(this, this.jumpHighHandle));\r\n    }\r\n    jumpHighHandle() {\r\n        this.bodyScript.keyJump = true;\r\n    }\r\n    jumpEnd() {\r\n        console.log(\"PLAYER_COLLISION_GROUND---\");\r\n        this.keyJump = false;\r\n        if (this.sBoom) {\r\n            this.setBoomComplete();\r\n        }\r\n        else if (this.sFire) {\r\n            this.body.url = \"ui://Game/player_fire_\" + this.weaponType + \"_\" + this.direction;\r\n        }\r\n        if (this.sRun) {\r\n            this.bodyLeg.url = \"ui://Game/legMove\";\r\n            this.bodyLeg.content.rewind();\r\n            return;\r\n        }\r\n        this.stopMove();\r\n    }\r\n    setRun() {\r\n        EventManager.instance.dispatcherEvt(GameEvent.PLAYER_RUN);\r\n        if (this.sFire) {\r\n            this.body.url = \"ui://Game/player_fire_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        }\r\n        else {\r\n            this.body.url = \"ui://Game/player_stay_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        }\r\n        this.bodyLeg.url = \"ui://Game/legMove\";\r\n        this.sRun = true;\r\n        Laya.timer.clear(this, this.stillRun);\r\n        Laya.timer.frameLoop(1, this, this.stillRun);\r\n    }\r\n    stillRun() {\r\n        if (this.direction == 1) {\r\n            this.roleSprite.x += this.speed;\r\n            if (this.roleSprite.x > ViewManager.instance.warView.warView.width - this.roleSprite.width - 20)\r\n                this.roleSprite.x = ViewManager.instance.warView.warView.width - this.roleSprite.width - 20;\r\n            if (GameManager.instance.bossDeath) {\r\n                if (this.roleSprite.x > ViewManager.instance.warView.warView.width - 450) {\r\n                    GameManager.instance.victoryGame();\r\n                }\r\n            }\r\n            if (Math.abs(ViewManager.instance.warView.warView.x) + Laya.stage.width > ViewManager.instance.warView.warView.width - 20)\r\n                return;\r\n            if (this.roleSprite.x - Math.abs(ViewManager.instance.warView.warView.x) >= Laya.stage.width / 2) {\r\n                ViewManager.instance.updateViewPort(this.speed);\r\n            }\r\n        }\r\n        else if (this.direction == -1) {\r\n            this.roleSprite.x -= this.speed;\r\n            if (this.roleSprite.x < Math.abs(ViewManager.instance.warView.warView.x))\r\n                this.roleSprite.x = Math.abs(ViewManager.instance.warView.warView.x);\r\n        }\r\n    }\r\n    setFire() {\r\n        if (this.sFire)\r\n            return;\r\n        if (this.sBoom)\r\n            return;\r\n        if (this.stillRifle)\r\n            return;\r\n        this.playWeaponSound();\r\n        this.sFire = true;\r\n        this.body.url = \"ui://Game/player_fire_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        this.rolePlayer.m_fireType.selectedIndex = this.weaponType - 1;\r\n        this.setFireAniSkew();\r\n        Laya.timer.clear(this, this.stillFire);\r\n        this.rolePlayer[\"m_firePos\" + this.weaponType].visible = true;\r\n        if (this.weaponType != PlayerData.WEAPON_PIS) {\r\n            EventManager.instance.dispatcherEvt(GameEvent.USE_PLAYER_BULLET);\r\n        }\r\n        var b = ViewManager.instance.createBullet();\r\n        if (this.weaponType == PlayerData.WEAPON_RIFLE) {\r\n            this.stillRifle = true;\r\n            Laya.timer.once(700, this, this.rilfeComplete);\r\n            Laya.timer.loop(800, this, this.stillFire);\r\n        }\r\n        else {\r\n            this.stillRifle = false;\r\n            Laya.timer.loop(150, this, this.stillFire);\r\n        }\r\n        if (this.sRun) {\r\n            this.bodyLeg.url = \"ui://Game/legMove\";\r\n            return;\r\n        }\r\n        if (this.keyJump)\r\n            this.bodyLeg.url = \"ui://Game/legJump\";\r\n    }\r\n    stillFire() {\r\n        if (this.sBoom)\r\n            return;\r\n        this.setFireAniSkew();\r\n        this.stillFireNum++;\r\n        if (this.stillFireNum % 2 == 0) {\r\n            this.rolePlayer.m_firePos1.visible = this.rolePlayer.m_firePos2.visible = false;\r\n        }\r\n        else {\r\n            this.rolePlayer[\"m_firePos\" + this.weaponType].visible = true;\r\n        }\r\n        ViewManager.instance.createBullet();\r\n        if (this.weaponType != PlayerData.WEAPON_PIS) {\r\n            EventManager.instance.dispatcherEvt(GameEvent.USE_PLAYER_BULLET);\r\n        }\r\n        this.playWeaponSound();\r\n    }\r\n    setFireAniSkew() {\r\n        this.rolePlayer.m_firePos.selectedIndex = Math.abs(this.faceType) - 1;\r\n        if (Math.abs(this.faceType) == 1) {\r\n            this.rolePlayer.m_firePos1.setSkew(180, 180);\r\n            this.rolePlayer.m_firePos2.setSkew(180, 180);\r\n        }\r\n        else if (Math.abs(this.faceType) == 2) {\r\n            this.rolePlayer.m_firePos1.setSkew(160, 160);\r\n            this.rolePlayer.m_firePos2.setSkew(160, 160);\r\n        }\r\n        else if (Math.abs(this.faceType) == 3) {\r\n            this.rolePlayer.m_firePos1.setSkew(200, 200);\r\n            this.rolePlayer.m_firePos2.setSkew(200, 200);\r\n        }\r\n    }\r\n    rilfeComplete() {\r\n        this.stillRifle = false;\r\n    }\r\n    setFireEnd() {\r\n        Laya.timer.clear(this, this.stillFire);\r\n        this.sFire = false;\r\n        this.stillFireNum = 1;\r\n        this.rolePlayer.m_firePos1.visible = this.rolePlayer.m_firePos2.visible = false;\r\n        this.body.url = \"ui://Game/player_stay_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        this.body.content.setPlaySettings(0, -1, 0, 0);\r\n        if (this.sRun) {\r\n            this.bodyLeg.url = \"ui://Game/legMove\";\r\n            this.bodyLeg.content.setPlaySettings(0, -1, 0, 0);\r\n            return;\r\n        }\r\n        if (this.keyJump)\r\n            this.bodyLeg.url = \"ui://Game/legJump\";\r\n    }\r\n    setBoom() {\r\n        this.sBoom = true;\r\n        EventManager.instance.dispatcherEvt(GameEvent.USE_PLAYER_BOMB);\r\n        this.body.url = \"ui://Game/player_boom_\" + this.weaponType;\r\n        this.bodybody.content.setPlaySettings(0, -1, 1, -1);\r\n        Laya.timer.once(700, this, this.setBoomComplete);\r\n        ViewManager.instance.createBomb(PlayerData.WEAPON_GRE, this.direction, ViewManager.instance.getBodyCenterPos(this.roleSprite), true);\r\n    }\r\n    setBoomComplete() {\r\n        this.sBoom = false;\r\n        if (this.sFire)\r\n            this.body.url = \"ui://Game/player_fire_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        else\r\n            this.body.url = \"ui://Game/player_stay_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n    }\r\n    stopMove() {\r\n        EventManager.instance.dispatcherEvt(GameEvent.PLAYER_STAY);\r\n        this.keyLeft = false;\r\n        this.keyRight = false;\r\n        this.sRun = false;\r\n        this.bodyLeg.url = \"ui://Game/legStay\";\r\n        Laya.timer.clear(this, this.stillRun);\r\n    }\r\n    setStay() {\r\n        if (this.faceType > 0) {\r\n            this.direction = 1;\r\n            this.rolePlayer.skewY = 180;\r\n        }\r\n        else {\r\n            this.direction = -1;\r\n            this.rolePlayer.skewY = 0;\r\n        }\r\n        this.body.url = \"ui://Game/player_stay_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n        Laya.timer.clear(this, this.stillFire);\r\n        this.stopMove();\r\n    }\r\n    changeWeaponType(type) {\r\n        this.weaponType = GameManager.instance.roleInfo.weaponType = type;\r\n        if (this.sFire) {\r\n            Laya.timer.clear(this, this.stillFire);\r\n            this.sFire = false;\r\n            this.setFire();\r\n        }\r\n        else\r\n            this.body.url = \"ui://Game/player_stay_\" + this.weaponType + \"_\" + Math.abs(this.faceType);\r\n    }\r\n    setDeath() {\r\n        if (GameManager.instance.roleInfo.isDeath)\r\n            return;\r\n        GameManager.instance.roleInfo.isDeath = true;\r\n        Laya.timer.clearAll(this);\r\n        EventManager.instance.offNotice(GameEvent.ENEMY_BULLET_HIT_PLAYER, this, this.beHit);\r\n        EventManager.instance.offNotice(GameEvent.ENEMY_BOMB_HIT_PLAYER, this, this.beHit);\r\n        this.body.url = \"ui://Game/player_death\";\r\n        this.body.content.setPlaySettings(0, -1, 1, this.body.content.frameCount - 1, Laya.Handler.create(this, this.deathComplete));\r\n        this.playDeathSound();\r\n    }\r\n    playDeathSound() {\r\n        var s = 1;\r\n        var r = Math.random();\r\n        if (r > 0.75)\r\n            s = 4;\r\n        if (r > 0.5)\r\n            s = 3;\r\n        if (r > 0.25)\r\n            s = 2;\r\n        s = 1;\r\n        SoundManager.instance.playSound(\"die_\" + s);\r\n    }\r\n    playWeaponSound() {\r\n        SoundManager.instance.playSound(\"weapon_\" + this.weaponType);\r\n    }\r\n    deathComplete() {\r\n    }\r\n    beHit() {\r\n        if (GameManager.instance.roleInfo.isDeath)\r\n            return;\r\n        Laya.timer.clear(this, this.setColor);\r\n        this.bodyLeg.color = \"#ff0000\";\r\n        this.bodybody.color = \"#ff0000\";\r\n        Laya.timer.once(200, this, this.setColor);\r\n    }\r\n    setColor() {\r\n        if (GameManager.instance.roleInfo.isDeath)\r\n            return;\r\n        this.bodyLeg.color = \"#ffffff\";\r\n        this.bodybody.color = \"#ffffff\";\r\n    }\r\n    get bodyComponent() {\r\n        return this.body.component;\r\n    }\r\n    get bodyLeg() {\r\n        return this.bodyComponent.getChildAt(0).asLoader;\r\n    }\r\n    get bodybody() {\r\n        return this.bodyComponent.getChildAt(1).asLoader;\r\n    }\r\n    dispose() {\r\n        this.playerCtlView.view.m_fire.off(Laya.Event.MOUSE_DOWN, this, this.setFire);\r\n        this.playerCtlView.view.m_fire.off(Laya.Event.MOUSE_UP, this, this.setFireEnd);\r\n        this.playerCtlView.view.m_bomb.off(Laya.Event.CLICK, this, this.onClickBomb);\r\n        this.playerCtlView.view.m_jump.off(Laya.Event.CLICK, this, this.onClickJump);\r\n        this.playerCtlView.view.m_ctl.m_mask.off(Laya.Event.MOUSE_DOWN, this, this.addMouseDown);\r\n        this.playerCtlView.view.m_ctl.m_mask.off(Laya.Event.MOUSE_UP, this, this.addCtlViewMouseUp);\r\n        Laya.stage.off(Laya.Event.MOUSE_UP, this, this.addStageMouseUp);\r\n        EventManager.instance.offNotice(GameEvent.PLAYER_COLLISION_GROUND, this, this.colliGround);\r\n        EventManager.instance.offNotice(GameEvent.ENEMY_BULLET_HIT_PLAYER, this, this.beHit);\r\n        EventManager.instance.offNotice(GameEvent.ENEMY_BOMB_HIT_PLAYER, this, this.beHit);\r\n        EventManager.instance.offNotice(GameEvent.CHANGE_PLAYER_WEAPON, this, this.changeWeaponType);\r\n        EventManager.instance.offNotice(GameEvent.PLAYER_DEATH, this, this.setDeath);\r\n        Laya.timer.clearAll(this);\r\n        this.roleSprite.removeChildren();\r\n        this.roleSprite.removeSelf();\r\n        this.rolePlayer.dispose();\r\n        this.roleSprite.destroy();\r\n        this.roleSprite = null;\r\n        this.recover();\r\n    }\r\n    recover() {\r\n        Laya.Pool.recover(\"player\", this);\r\n    }\r\n}\r\n",
  "references": [
    "D:/littleGame/gunfire/src/fui/Game/WXFUI_Player.ts",
    "D:/littleGame/gunfire/src/View/PlayerAni.ts",
    "D:/littleGame/gunfire/src/Manager/ViewManager.ts",
    "D:/littleGame/gunfire/src/View/Body/PlayerBody.ts",
    "D:/littleGame/gunfire/src/View/BoomView.ts",
    "D:/littleGame/gunfire/src/Manager/EventManager.ts",
    "D:/littleGame/gunfire/src/Control/GameEvent.ts",
    "D:/littleGame/gunfire/src/Manager/GameManager.ts",
    "D:/littleGame/gunfire/src/Data/PlayerData.ts",
    "D:/littleGame/gunfire/src/Manager/SoundManager.ts",
    "D:/littleGame/gunfire/src/View/PlayerCtlView.ts",
    "D:/littleGame/gunfire/src/View/PlayerBullet.ts"
  ]
}
